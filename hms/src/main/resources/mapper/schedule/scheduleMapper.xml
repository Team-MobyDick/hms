<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.mobydick.hms.schedule.dao.ScheduleDAO">

    <!-- 전체 스케줄 조회 -->
    <select id="getAllSchedules" resultType="com.mobydick.hms.schedule.vo.ScheduleVO">
        SELECT
            SCHE_ID,
            SCHE_DATE,
            EMPL_ID,
            SCHE_SHIFT,
            CREATED_DATE,
            CREATED_ID,
            UPDATED_DATE,
            UPDATED_ID
        FROM
            TB_SCHEDULE
    </select>

    <!-- GR_01: 자기 부서 전체 일정 (부서명 포함) -->
    <select id="getSchedulesForAdmin" resultType="com.mobydick.hms.schedule.vo.ScheduleVO">
        SELECT
            S.SCHE_ID,
            S.SCHE_DATE,
            S.EMPL_ID,
            S.SCHE_SHIFT,
            C.CODE_NAME AS DEPT_NAME,
            S.CREATED_DATE,
            S.CREATED_ID,
            S.UPDATED_DATE,
            S.UPDATED_ID
        FROM TB_SCHEDULE S
                 JOIN TB_EMPL E ON S.EMPL_ID = E.EMPL_ID
                 JOIN TB_CODE C ON E.EMPL_DEPT = C.CODE_ID
        WHERE E.EMPL_DEPT = #{deptId}
    </select>

    <!-- GR_02: 팀장 - 본인 팀 팀원 일정 -->
    <select id="getSchedulesByTeamLeader" resultType="com.mobydick.hms.schedule.vo.ScheduleVO">
        SELECT S.*
        FROM TB_SCHEDULE S
        WHERE S.EMPL_ID IN (
            SELECT E.EMPL_ID
            FROM TB_EMPL E
            WHERE E.EMPL_DEPT = (
                SELECT EMPL_DEPT FROM TB_EMPL WHERE EMPL_ID = #{emplId}
            )
        )
    </select>

    <!-- GR_03: 본인 일정 -->
    <select id="getSchedulesByEmployee" resultType="com.mobydick.hms.schedule.vo.ScheduleVO">
        SELECT * FROM TB_SCHEDULE
        WHERE EMPL_ID = #{emplId}
    </select>

    <insert id="insertSchedule" parameterType="com.mobydick.hms.schedule.vo.ScheduleVO">
        INSERT INTO TB_SCHEDULE (
            SCHE_ID, SCHE_DATE, EMPL_ID, SCHE_SHIFT,
            CREATED_DATE, CREATED_ID, UPDATED_DATE, UPDATED_ID, DUP_CHECK
        )
        VALUES (
                   #{scheId}, #{scheDate}, #{emplId}, #{scheShift},
                   SYSDATE, #{createdId}, SYSDATE, #{updatedId}, #{dupCheck}
               )
    </insert>

    <!-- 등급: GR_01 전체 직원 -->
    <select id="getAllEmployees" resultType="com.mobydick.hms.schedule.vo.EmpVO">
        SELECT E.EMPL_ID, E.EMPL_NAME, C.CODE_NAME AS DEPT_NAME
        FROM TB_EMPL E
                 JOIN TB_CODE C ON E.EMPL_DEPT = C.CODE_ID
    </select>

    <!-- 등급: GR_02 팀장 - 자기 부서 직원만 -->
    <select id="getEmployeesByDept" resultType="com.mobydick.hms.schedule.vo.EmpVO">
        SELECT E.EMPL_ID, E.EMPL_NAME, C.CODE_NAME AS DEPT_NAME
        FROM TB_EMPL E
                 JOIN TB_CODE C ON E.EMPL_DEPT = C.CODE_ID
        WHERE E.EMPL_DEPT = #{deptId}
    </select>

    <select id="getScheduleDetail" parameterType="String" resultType="com.mobydick.hms.schedule.vo.ScheduleDetailVO">
        SELECT
            s.SCHE_ID,
            s.SCHE_DATE,
            c_shift.CODE_NAME AS scheShiftName,
            e.EMPL_NAME,
            w.WORKD_NAME,
            w.WORKD_CONTEXT,
            c_impo.CODE_NAME AS workdImpoName,
            c_state.CODE_NAME AS workdStateName,
            r.ROOM_NAME
        FROM TB_SCHEDULE s
                 JOIN TB_EMPL e ON s.EMPL_ID = e.EMPL_ID
                 LEFT JOIN TB_WORK_D w ON s.SCHE_ID = w.WORKD_ID
                 LEFT JOIN TB_CODE c_shift ON s.SCHE_SHIFT = c_shift.CODE_ID
                 LEFT JOIN TB_CODE c_impo ON w.WORKD_IMPO = c_impo.CODE_ID
                 LEFT JOIN TB_CODE c_state ON w.WORKD_DEPT = c_state.CODE_ID
                 LEFT JOIN TB_ROOM r ON w.ROOM_ID = r.ROOM_ID
        WHERE s.SCHE_ID = #{scheId}
    </select>

    <select id="getScheduleByDate" parameterType="String" resultType="com.mobydick.hms.schedule.vo.ScheduleDetailVO">
        SELECT
            s.SCHE_ID,
            s.SCHE_DATE,
            e.EMPL_NAME,
            w.WORKD_NAME,
            c_state.CODE_NAME AS workdStateName
        FROM TB_SCHEDULE s
                 JOIN TB_EMPL e ON s.EMPL_ID = e.EMPL_ID
                 LEFT JOIN TB_WORK_D w ON s.EMPL_ID = w.EMPL_ID AND s.SCHE_DATE = w.WORKD_DATE
                 LEFT JOIN TB_CODE c_state ON w.WORKD_DEPT = c_state.CODE_ID
        WHERE s.SCHE_DATE LIKE #{start}
    </select>

    <select id="getSchedulesForAdminBetween" parameterType="map" resultType="com.mobydick.hms.schedule.vo.ScheduleVO">
        SELECT
            s.SCHE_ID,
            s.SCHE_DATE,
            s.EMPL_ID,
            s.SCHE_SHIFT,
            c_dept.CODE_NAME AS DEPT_NAME,
            c_shift.CODE_NAME AS scheShiftName
        FROM TB_SCHEDULE s
                 JOIN TB_EMPL e ON s.EMPL_ID = e.EMPL_ID
                 LEFT JOIN TB_CODE c_dept ON e.EMPL_DEPT = c_dept.CODE_ID
                 LEFT JOIN TB_CODE c_shift ON s.SCHE_SHIFT = c_shift.CODE_ID
        WHERE TO_CHAR(s.SCHE_DATE, 'YYYYMMDD') BETWEEN #{start} AND #{end}
    </select>

    <select id="getSchedulesByTeamLeaderBetween" parameterType="map" resultType="com.mobydick.hms.schedule.vo.ScheduleVO">
        SELECT
            s.SCHE_ID,
            s.SCHE_DATE,
            s.EMPL_ID,
            s.SCHE_SHIFT
        FROM TB_SCHEDULE s
                 JOIN TB_EMPL e ON s.EMPL_ID = e.EMPL_ID
        WHERE TO_CHAR(s.SCHE_DATE, 'YYYYMMDD') BETWEEN #{start} AND #{end}
    </select>

    <select id="getSchedulesByEmployeeBetween" parameterType="map" resultType="com.mobydick.hms.schedule.vo.ScheduleVO">
        SELECT
            s.SCHE_ID,
            s.SCHE_DATE,
            s.EMPL_ID,
            s.SCHE_SHIFT
        FROM TB_SCHEDULE s
        WHERE s.EMPL_ID = #{emplId}
          AND TO_CHAR(s.SCHE_DATE, 'YYYYMMDD') BETWEEN #{start} AND #{end}
    </select>

    <delete id="deleteSchedule" parameterType="String">
        DELETE FROM TB_SCHEDULE
        WHERE SCHE_ID = #{scheId}
    </delete>

</mapper>
